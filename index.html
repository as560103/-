#include <ESP8266WiFi.h>
#include <WiFiUdp.h>
#include <NTPClient.h>

const char* ssid = "你的WiFi名稱";
const char* password = "你的WiFi密碼";

// NTP伺服器
const char* ntpServer = "pool.ntp.org";

// 設定時區（台灣為 UTC+8）
const long gmtOffset_sec = 8 * 3600;
const int daylightOffset_sec = 0;

WiFiUDP udp;
NTPClient timeClient(udp, ntpServer, gmtOffset_sec, 60000);  // 每 60000 毫秒更新一次時間

void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("Connected to WiFi");

  timeClient.begin();
}

void loop() {
  timeClient.update();
  
  // 將時間轉換為 UTC 格式並打印
  String formattedTime = timeClient.getFormattedTime();
  Serial.println(formattedTime);

  // 將格式化後的時間發送到 ThingSpeak
  sendToThingSpeak(formattedTime);

  delay(10000);  // 每 10 秒更新一次
}

// 將時間發送到 ThingSpeak
void sendToThingSpeak(String formattedTime) {
  String url = "https://api.thingspeak.com/update?api_key=你的WriteAPIKey&field1=" + formattedTime;

  WiFiClient client;
  if (client.connect("api.thingspeak.com", 80)) {
    client.println("GET " + url + " HTTP/1.1");
    client.println("Host: api.thingspeak.com");
    client.println("Connection: close");
    client.println();
  }
}
